#!/usr/bin/env bash

ref_path = "~/project/EpiAllele/ref/mouse"
cd $ref_path
gunzip Mus_musculus.GRCm39.dna.primary_assembly.fa.gz

## filter the GTF: remove non-polyA transcripts that overlap with protein-coding gene models
cellranger mkgtf \
    Mus_musculus.GRCm39.113.gtf.gz \
    Mus_musculus.GRCm39.113.filtered.gtf \
    --attribute=gene_biotype:protein_coding

## Add AAV-C and AAV-N to the FASTA and GTF
### construct fasta and gtf files for AAV-C and AAV-N
echo ">AAV-C" > AAV-C.fa
echo "AAACGGACAGCCGACGGAAGCGAGTTCGAGTCACCAAAGAAGAAGCGGAAAGTCATCAAGATCGCCACCAGGAAGTACCTGGGCAAGCAGAACGTGTACGACATCGGCGTGGAGAGGGACCACAACTTCGCCCTGAAGAACGGCTTCATCGCCAGCAATTGCTTCGACTCCGTGGAAATCTCCGGCGTGGAAGATCGGTTCAACGCCTCCCTGGGCACATACCACGATCTGCTGAAAATTATCAAGGACAAGGACTTCCTGGACAATGAGGAAAACGAGGACATTCTGGAAGATATCGTGCTGACCCTGACACTGTTTGAGGACAGAGAGATGATCGAGGAACGGCTGAAAACCTATGCCCACCTGTTCGACGACAAAGTGATGAAGCAGCTGAAGCGGCGGAGATACACCGGCTGGGGCAGGCTGAGCCGGAAGCTGATCAACGGCATCCGGGACAAGCAGTCCGGCAAGACAATCCTGGATTTCCTGAAGTCCGACGGCTTCGCCAACAGAAACTTCATGCAGCTGATCCACGACGACAGCCTGACCTTTAAAGAGGACATCCAGAAAGCCCAGGTGTCCGGCCAGGGCGATAGCCTGCACGAGCACATTGCCAATCTGGCCGGCAGCCCCGCCATTAAGAAGGGCATCCTGCAGACAGTGAAGGTGGTGGACGAGCTCGTGAAAGTGATGGGCCGGCACAAGCCCGAGAACATCGTGATCGAAATGGCCAGAGAGAACCAGACCACCCAGAAGGGACAGAAGAACAGCCGCGAGAGAATGAAGCGGATCGAAGAGGGCATCAAAGAGCTGGGCAGCCAGATCCTGAAAGAACACCCCGTGGAAAACACCCAGCTGCAGAACGAGAAGCTGTACCTGTACTACCTGCAGAATGGGCGGGATATGTACGTGGACCAGGAACTGGACATCAACCGGCTGTCCGACTACGATGTGGACGCTATCGTGCCTCAGAGCTTTCTGAAGGACGACTCCATCGATAACAAAGTGCTGACTCGGAGCGACAAGAACCGGGGCAAGAGCGACAACGTGCCCTCCGAAGAGGTCGTGAAGAAGATGAAGAACTACTGGCGCCAGCTGCTGAATGCCAAGCTGATTACCCAGAGGAAGTTCGACAATCTGACCAAGGCCGAGAGAGGCGGCCTGAGCGAACTGGATAAGGCCGGCTTCATCAAGAGACAGCTGGTGGAAACCCGGCAGATCACAAAGCACGTGGCACAGATCCTGGACTCCCGGATGAACACTAAGTACGACGAGAACGACAAACTGATCCGGGAAGTGAAAGTGATCACCCTGAAGTCCAAGCTGGTGTCCGATTTCCGGAAGGATTTCCAGTTTTACAAAGTGCGCGAGATCAACAACTACCACCACGCCCACGACGCCTACCTGAACGCCGTCGTGGGAACCGCCCTGATCAAAAAGTACCCTAAGCTGGAAAGCGAGTTCGTGTACGGCGACTACAAGGTGTACGACGTGCGGAAGATGATCGCCAAGAGCGAGCAGGAAATCGGCAAGGCTACCGCCAAGTACTTCTTCTACAGCAACATCATGAACTTTTTCAAGACCGAGATTACCCTGGCCAACGGCGAGATCCGGAAGCGGCCTCTGATCGAGACAAACGGCGAAACAGGCGAGATCGTGTGGGATAAGGGCCGGGACTTTGCCACCGTGCGGAAAGTGCTGTCTATGCCCCAAGTGAATATCGTGAAAAAGACCGAGGTGCAGACAGGCGGCTTCAGCAAAGAGTCTATCCTGCCCAAGAGGAACAGCGACAAGCTGATCGCCAGAAAGAAGGACTGGGACCCTAAGAAGTACGGCGGCTTCGACAGCCCCACCGTGGCCTATTCTGTGCTGGTGGTGGCCAAAGTGGAAAAGGGCAAGTCCAAGAAACTGAAGAGTGTGAAAGAGCTGCTGGGGATCACCATCATGGAAAGAAGCAGCTTCGAGAAGAATCCCATCGACTTTCTGGAAGCCAAGGGCTACAAAGAAGTGAAAAAGGACCTGATCATCAAGCTGCCTAAGTA" >> AAV-C.fa

echo ">AAV-N
GACTATAAGGACCACGACGGAGACTACAAGGATCATGATATTGATTACAAAGACGATGACGATAAGAAACGGACAGCCGACGGAAGCGAGTTCGAGTCACCAAAGAAGAAGCGGAAAGTCAACCATGACCAGGAATTTGACCCCCCAAAGGTTTACCCACCTGTGCCAGCTGAGAAGAGGAAGCCCATCCGCGTGCTGTCTCTCTTTGATGGGATTGCTACAGGGCTCCTGGTGCTGAAGGACCTGGGCATCCAAGTGGACCGCTACATTGCCTCCGAGGTGTGTGAGGACTCCATCACGGTGGGCATGGTGCGGCACCAGGGAAAGATCATGTACGTCGGGGACGTCCGCAGCGTCACACAGAAGCATATCCAGGAGTGGGGCCCATTCGACCTGGTGATTGGAGGCAGTCCCTGCAATGACCTCTCCATTGTCAACCCTGCCCGCAAGGGACTTTATGAGGGTACTGGCCGCCTCTTCTTTGAGTTCTACCGCCTCCTGCATGATGCGCGGCCCAAGGAGGGAGATGATCGCCCCTTCTTCTGGCTCTTTGAGAATGTGGTGGCCATGGGCGTTAGTGACAAGAGGGACATCTCGCGATTTCTTGAGTCTAACCCCGTGATGATTGACGCCAAAGAAGTGTCTGCTGCACACAGGGCCCGTTACTTCTGGGGTAACCTTCCTGGCATGAACAGGCCTTTGGCATCCACTGTGAATGATAAGCTGGAGCTGCAAGAGTGTCTGGAGCACGGCAGAATAGCCAAGTTCAGCAAAGTGAGGACCATTACCACCAGGTCAAACTCTATAAAGCAGGGCAAAGACCAGCATTTCCCCGTCTTCATGAACGAGAAGGAGGACATCCTGTGGTGCACTGAAATGGAAAGGGTGTTTGGCTTCCCCGTCCACTACACAGACGTCTCCAACATGAGCCGCTTGGCGAGGCAGAGACTGCTGGGCCGATCGTGGAGCGTGCCGGTCATCCGCCACCTCTTCGCTCCGCTGAAGGAATATTTTGCTTGTGTGTCTAGCGGCAATAGTAACGCTAACAGCCGCGGGCCGAGCTTCAGCAGCGGCCTGGTGCCGTTAAGCTTGCGCGGCAGCCATATGGGCCCTATGGAGATATACAAGACAGTGTCTGCATGGAAGAGACAGCCAGTGCGGGTACTGAGCCTCTTCAGAAACATCGACAAGGTACTAAAGAGTTTGGGCTTCTTGGAAAGCGGTTCTGGTTCTGGGGGAGGAACGCTGAAGTACGTGGAAGATGTCACAAATGTCGTGAGGAGAGACGTGGAGAAATGGGGCCCCTTTGACCTGGTGTACGGCTCGACGCAGCCCCTAGGCAGCTCTTGTGATCGCTGTCCCGGCTGGTACATGTTCCAGTTCCACCGGATCCTGCAGTATGCGCTGCCTCGCCAGGAGAGTCAGCGGCCCTTCTTCTGGATATTCATGGACAATCTGCTGCTGACTGAGGATGACCAAGAGACAACTACCCGCTTCCTTCAGACAGAGGCTGTGACCCTCCAGGATGTCCGTGGCAGAGACTACCAGAATGCTATGCGGGTGTGGAGCAACATTCCAGGGCTGAAGAGCAAGCATGCGCCCCTGACCCCAAAGGAAGAAGAGTATCTGCAAGCCCAAGTCAGAAGCAGGAGCAAGCTGGACGCCCCGAAAGTTGACCTCCTGGTGAAGAACTGCCTTCTCCCGCTGAGAGAGTACTTCAAGTATTTTTCTCAAAACTCACTTCCTCTTGGAGGGCCGAGCTCTGGCGCACCCCCACCAAGTGGAGGGTCTCCTGCCGGGTCCCCAACATCTACTGAAGAAGGCACCAGCGAATCCGCAACGCCCGAGTCAGGCCCTGGTACCTCCACAGAACCATCTGAAGGTAGTGCGCCTGGTTCCCCAGCTGGAAGCCCTACTTCCACCGAAGAAGGCACGTCAACCGAACCAAGTGAAGGATCTGCCCCTGGGACCAGCACTGAACCATCTGAGCCAAAAAAGAAGAGAAAGGTAATGGACAAGAAGTACAGCATCGGCCTGGCCA" AAV-C.fa

cat AAV-C.fa | grep -v "^>" | tr -d "\n" | wc -c
cat AAV-N.fa | grep -v "^>" | tr -d "\n" | wc -c

echo -e 'AAV-C\tunknown\texon\t1\t2042\t.\t+\t.\tgene_id "AAV-C"; transcript_id "AAV-C"; gene_name "AAV-C"; gene_biotype "protein_coding";' > AAV-C.gtf
echo -e 'AAV-N\tunknown\texon\t1\t2041\t.\t+\t.\tgene_id "AAV-N"; transcript_id "AAV-N"; gene_name "AAV-N"; gene_biotype "protein_coding";' > AAV-N.gtf

### add AAV-N and AAV-C sequence to ref genome fasta file
cp Mus_musculus.GRCm39.dna.primary_assembly.fa Mus_musculus.GRCm39.dna.primary_assembly_AAV.fa
cat AAV-C.fa >> Mus_musculus.GRCm39.dna.primary_assembly_AAV.fa
cat AAV-N.fa >> Mus_musculus.GRCm39.dna.primary_assembly_AAV.fa

grep ">" Mus_musculus.GRCm39.dna.primary_assembly_AAV.fa | tail
grep -c "^>" Mus_musculus.GRCm39.dna.primary_assembly.fa
grep -c "^>" Mus_musculus.GRCm39.dna.primary_assembly_AAV.fa

### add AAV-N and AAV-C annotation info to gtf annotation file
cp Mus_musculus.GRCm39.113.filtered.gtf Mus_musculus.GRCm39.113.filtered.AAV.gtf
cat AAV-C.gtf >> Mus_musculus.GRCm39.113.filtered.AAV.gtf
cat AAV-N.gtf >> Mus_musculus.GRCm39.113.filtered.AAV.gtf
tail Mus_musculus.GRCm39.113.filtered.AAV.gtf

## construct ref genome
cellranger mkref --genome=Mus_musculus_GRCm39_AAV_genome \
    --fasta=Mus_musculus.GRCm39.dna.primary_assembly_AAV.fa \
    --genes=Mus_musculus.GRCm39.113.filtered.AAV.gtf